name: Deploy FastAPI + Ngrok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Clonar el repositorio
    - name: Checkout code
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Configurar Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3Ô∏è‚É£ Instalar dependencias
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyngrok uvicorn fastapi

    # 4Ô∏è‚É£ Instalar Ngrok
    - name: Install Ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc > /dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install -y ngrok jq net-tools

    # 5Ô∏è‚É£ Crear ngrok.yml en la ra√≠z con tu token secreto
    - name: Crear ngrok.yml
      run: |
        echo "version: 3" > ngrok.yml
        echo "agent:" >> ngrok.yml
        echo "  authtoken: ${{ secrets.NGROK_AUTHTOKEN }}" >> ngrok.yml

    # 6Ô∏è‚É£ Iniciar FastAPI primero
    - name: Start FastAPI
      run: |
       cd FastApi
       nohup uvicorn main:app --host 0.0.0.0 --port 8000 > ../uvicorn.log 2>&1 &
       sleep 10
       echo "FastAPI app running on port 8000"


    # 7Ô∏è‚É£ Test de FastAPI (punto 4)
    - name: Test FastAPI
      run: curl http://127.0.0.1:8000/ping


    # 8Ô∏è‚É£ Iniciar Ngrok despu√©s de FastAPI
    - name: Start Ngrok
      run: |
        nohup ngrok http 8000 --config ngrok.yml > ngrok.log 2>&1 &
        sleep 10
        NGROK_URL=$(curl --silent http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "NGROK_URL=${NGROK_URL}" >> $GITHUB_ENV

    # 9Ô∏è‚É£ Mostrar la URL p√∫blica
    - name: Print Ngrok URL
      run: echo "Your public URL is $NGROK_URL"

    # üîü Debug opcional
    - name: Debug Info
      run: |
        echo "Running processes:"
        ps aux
        echo "Listening ports:"
        sudo netstat -tulpn
